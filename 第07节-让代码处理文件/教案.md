# 第7节：让代码处理文件

## 课时信息

| 项目 | 内容 |
|:---|:---|
| 所属阶段 | 基础课（第7节/共8节） |
| 主讲 | 沈林伟 |
| 辅助 | 梅杭俊（巡场、辅助答疑） |
| 时长 | 45 分钟 |
| 前置要求 | 学员已完成第6节，能读懂 if/else 和 for 循环 |

## 教学目标

学完本节课，学员能够：

1. 理解"读取 → 处理 → 写入"的数据处理模式
2. 用 Claude Code 生成读写文本文件的代码并读懂
3. 用 Claude Code 生成处理 CSV 文件的代码（筛选、统计）
4. 修改筛选条件或输出格式

## 核心理念（上课前讲师务必读）

> **本节课的关键词是"让代码干活"。**
>
> 前两节课程序都在屏幕上打印结果。这节课要让学员看到：代码可以读真实的文件、处理数据、生成新文件。这是编程从"玩具"变成"工具"的转折点。
>
> 学员不需要记住 `open()`、`csv.reader()` 等语法。他们需要掌握的是：
> - 看到代码知道"这段是在读文件"、"这段是在写文件"、"这段是在筛选数据"
> - 能修改筛选条件（比如把"迟到"改成"缺勤"）
> - 能向 Claude Code 描述自己想要的数据处理需求
>
> 核心模式只有一个：**读取 → 处理 → 写入**。所有文件操作都是这个模式的变体。

---

## 教学流程

### 第一部分：学员回顾（5分钟）[0:00-0:05]

**讲师操作：**

> 讲师说："上节课我们学了两个重要概念。谁来说说是哪两个？"

- 请1-2位学员回顾 if/else 和 for 循环
- 引导学员用自己的话说，比如"if 就是做判断"、"for 就是重复做事"

**预期回答要点：**
- if/else：程序做判断，根据条件走不同的路
- for 循环：对一堆东西，每个都做同样的操作
- 能修改条件和参数

**讲师总结（30秒）：**

> "非常好。上节课的程序处理的数据都是我们在代码里写死的——成绩、工资什么的都写在代码里面。但实际工作中，数据在哪里？在**文件**里。Excel表格、文本文件、CSV表格……今天我们来看看怎么让代码直接读取和处理这些文件。"

---

### 第二部分：文本文件操作（12分钟）[0:05-0:17]

#### 2.1 概念引入（2分钟）

**讲师说：**

> "我们平时怎么处理一个文件？打开它、看内容、做点事情、保存关闭。程序处理文件的步骤一模一样：**打开 → 读内容 → 处理 → 写到新文件**。"
>
> "我们来让 Claude Code 写一个程序：读取一个文本文件，数一数有多少字、多少行，把统计结果写到另一个文件里。"

#### 2.2 准备测试文件 + 用 Claude Code 生成代码（3分钟）

**讲师操作（投影演示）：**

先让 Claude Code 创建一个测试文本文件：

```
claude "在当前目录创建一个叫 sample.txt 的文件，内容写几句关于学习编程的话，大概5-6行中文"
```

然后生成统计代码：

```
claude "写一个Python程序：读取 sample.txt 文件，统计它有多少行、多少个字符，把统计结果保存到 stats.txt 文件中。同时在屏幕上也打印结果。保存到 word_count.py"
```

**预期 Claude Code 生成的代码（`word_count.py`）：**

```python
# 文本文件统计工具

# 第一步：读取文件
with open("sample.txt", "r", encoding="utf-8") as f:
    content = f.read()

# 第二步：处理（统计）
lines = content.strip().split("\n")
line_count = len(lines)
char_count = len(content)
char_count_no_space = len(content.replace(" ", "").replace("\n", ""))

# 第三步：写入结果
result = f"""文件统计结果
==============
文件名：sample.txt
总行数：{line_count}
总字符数：{char_count}
字符数（不含空格和换行）：{char_count_no_space}
"""

with open("stats.txt", "w", encoding="utf-8") as f:
    f.write(result)

print(result)
print("统计结果已保存到 stats.txt")
```

#### 2.3 逐行阅读代码（5分钟）-- 本节核心

**讲师说：**

> "代码生成了。我们来读。这段代码清晰地分成三步，注释都写了：第一步读取，第二步处理，第三步写入。"

**逐行阅读指南：**

| 代码行 | 讲师说 |
|:---|:---|
| `with open("sample.txt", "r", ...) as f:` | **（重点）** "这一行是**打开文件**。`open` 就是打开，`'r'` 是 read 的缩写，意思是'以读取模式打开'。`as f` 是给这个打开的文件取个代号叫 f。`with` 的意思是'用完了自动关闭'，不用你操心关文件的事。" |
| `content = f.read()` | "读取文件的全部内容，存到 content 变量里。" |
| `lines = content.strip().split("\\n")` | "把内容按换行符分成一行一行的，存到列表里。" |
| `len(lines)` / `len(content)` | "`len()` 是数数的意思——数一下有多少行、多少个字符。" |
| `with open("stats.txt", "w", ...) as f:` | **（重点）** "注意这里跟上面不一样了！`'w'` 是 write 的缩写，**写入模式**。意思是'创建一个新文件来写东西进去'。" |
| `f.write(result)` | "把结果写到文件里。" |

**关键强调：**

> "看到了吗？整个程序就三步：
> 1. **读取**：`open('文件', 'r')` → `read()`
> 2. **处理**：中间做统计
> 3. **写入**：`open('新文件', 'w')` → `write()`
>
> **这个模式记住了，以后所有文件处理都是这个套路。** 变的只是中间'处理'那一步。"

#### 2.4 运行验证（2分钟）

**讲师操作：**

```bash
python3 word_count.py
```

屏幕上看到统计结果。然后：

```bash
cat stats.txt
```

> "看，stats.txt 这个文件是程序自动创建的，内容就是统计结果。程序帮你干了：打开文件、数字数、写报告这三件事。"

---

### 第三部分：CSV 文件处理（13分钟）[0:17-0:30]

#### 3.1 概念引入（2分钟）

**讲师说：**

> "刚才处理的是普通文本。工作中更常见的是**表格数据**——比如考勤表、工资表、订单表。这些表格可以保存成 CSV 格式。CSV 就是'用逗号隔开的数据'，比如：
>
> `张三,2026-02-18,09:15,迟到`
>
> 每个逗号把一列数据隔开。Excel 能打开 CSV，程序也能读。今天我们让 Claude Code 写一个程序来处理考勤表。"

#### 3.2 准备考勤 CSV + 生成处理代码（3分钟）

**讲师操作（投影演示）：**

先创建考勤数据文件：

```
claude "创建一个考勤表 CSV 文件 attendance.csv，表头是：姓名,日期,到岗时间,状态。写入以下数据：
张三,2026-02-17,08:55,正常
李四,2026-02-17,09:20,迟到
王五,2026-02-17,08:50,正常
赵六,2026-02-17,,缺勤
钱七,2026-02-17,09:05,迟到
张三,2026-02-18,09:30,迟到
李四,2026-02-18,08:45,正常
王五,2026-02-18,,缺勤
赵六,2026-02-18,08:58,正常
钱七,2026-02-18,09:00,正常
张三,2026-02-19,08:50,正常
李四,2026-02-19,09:10,迟到
王五,2026-02-19,08:55,正常
赵六,2026-02-19,09:25,迟到
钱七,2026-02-19,08:48,正常"
```

然后生成处理代码：

```
claude "写一个Python程序：读取 attendance.csv 考勤表，筛选出所有状态为'迟到'的记录，生成一份迟到报告保存到 late_report.txt。报告格式要清晰好看，显示每条迟到记录的姓名、日期和到岗时间。最后显示迟到总次数。保存代码到 attendance.py"
```

**预期 Claude Code 生成的代码（`attendance.py`）：**

```python
import csv

# 第一步：读取 CSV 文件
late_records = []

with open("attendance.csv", "r", encoding="utf-8") as f:
    reader = csv.reader(f)
    header = next(reader)  # 跳过表头

    for row in reader:
        name = row[0]
        date = row[1]
        time = row[2]
        status = row[3]

        # 第二步：处理（筛选迟到记录）
        if status == "迟到":
            late_records.append({
                "姓名": name,
                "日期": date,
                "到岗时间": time
            })

# 第三步：写入报告
with open("late_report.txt", "w", encoding="utf-8") as f:
    f.write("考勤迟到报告\n")
    f.write("=" * 30 + "\n\n")

    for record in late_records:
        f.write(f"姓名：{record['姓名']}\n")
        f.write(f"日期：{record['日期']}\n")
        f.write(f"到岗时间：{record['到岗时间']}\n")
        f.write("-" * 20 + "\n")

    f.write(f"\n迟到总次数：{len(late_records)}\n")

print(f"筛选完成！共 {len(late_records)} 条迟到记录")
print("报告已保存到 late_report.txt")
```

#### 3.3 逐行阅读代码（5分钟）

**讲师说：**

> "又是同样的三步模式！我们来读。"

**逐行阅读指南：**

| 代码行 | 讲师说 |
|:---|:---|
| `import csv` | "导入处理 CSV 的工具包。" |
| `with open("attendance.csv", "r", ...) as f:` | "打开考勤表文件。跟刚才一样，`'r'` 是读取模式。" |
| `reader = csv.reader(f)` | "用 CSV 工具来读这个文件。它会自动按逗号把每行拆成多列。" |
| `header = next(reader)` | "跳过第一行表头（姓名、日期那一行），我们不需要处理它。" |
| `for row in reader:` | **（重点）** "看，又是循环！`for row in reader` 意思是：**对考勤表里的每一行数据，做下面的操作。**上节课学的 for 循环在这里就用上了。" |
| `name = row[0]` ... | "`row[0]` 是这一行的第一列（姓名），`row[1]` 是第二列（日期），以此类推。下标从0开始。" |
| `if status == "迟到":` | **（重点）** "又是条件判断！`if status == '迟到'`——如果这个人的状态是'迟到'，就把这条记录收集起来。**上节课的 if 在这里又用上了。**" |
| `late_records.append(...)` | "把这条迟到记录添加到列表里。" |
| 写入报告部分 | "最后用 `open('w')` 创建报告文件，把收集到的迟到记录一条条写进去。" |

**关键强调：**

> "注意看！整段代码的核心逻辑只有两个我们上节课学过的东西：
> - **for 循环**：遍历每一行考勤记录
> - **if 判断**：筛选出迟到的记录
>
> 加上这节课学的**读文件**和**写文件**，就构成了完整的数据处理程序。模式永远是：**读取 → 处理 → 写入**。"

#### 3.4 运行验证 + 展示完整流程（3分钟）

**讲师操作：**

```bash
python3 attendance.py
```

然后展示完整的输入输出链条：

```bash
echo "--- 原始数据 ---"
cat attendance.csv
echo ""
echo "--- 程序输出的报告 ---"
cat late_report.txt
```

> "看这个流程：左边是原始数据（15条考勤记录），经过程序处理，右边就只剩迟到的记录了。如果让你手动筛选，15条数据还行，150条呢？1500条呢？程序几秒钟就搞定。"

---

### 第四部分：学员练习（15分钟）[0:30-0:45]

#### 练习任务

| 序号 | 任务 | 预计用时 | 类型 |
|:---:|:---|:---:|:---:|
| 1 | 用 Claude Code 生成考勤筛选程序，筛选迟到记录，运行成功 | 5分钟 | 必做 |
| 2 | 修改筛选条件：把"迟到"改成"缺勤"，重新运行 | 3分钟 | 必做 |
| 3 | 挑战：统计每个人的迟到次数，生成汇总报告 | 7分钟 | 选做 |

#### 练习1：生成并运行考勤筛选程序

**投影显示给学员的 Claude Code 提示词：**

```
claude "写一个Python程序：读取 attendance.csv，筛选出所有迟到的记录，在屏幕上打印出来。保存到 my_attendance.py"
```

学员运行 `python3 my_attendance.py`，应看到迟到记录被打印出来。

**讲师确认问题：**

> "谁来告诉我，代码里哪一行在做筛选？"
>
> （期望答案：`if status == "迟到"` 或类似的判断行）

#### 练习2：修改筛选条件

**讲师说：**

> "现在需求变了：领导不想看迟到记录了，想看缺勤记录。怎么改？"

两种方式：
- 方式A：直接在代码里把 `"迟到"` 改成 `"缺勤"`
- 方式B：用 Claude Code：`claude "把 my_attendance.py 的筛选条件从'迟到'改成'缺勤'"`

运行验证，应该看到王五和赵六的缺勤记录。

#### 练习3（选做）：统计每人迟到次数

**提示词：**

```
claude "写一个Python程序：读取 attendance.csv，统计每个人的迟到次数，按迟到次数从多到少排序，把结果保存到 late_summary.txt。保存代码到 late_summary.py"
```

**预期输出示例（late_summary.txt）：**

```
迟到次数统计
==============
李四：2次
张三：1次
钱七：1次
赵六：1次
```

#### 练习期间讲师和助教分工

| 角色 | 职责 |
|:---|:---|
| 沈林伟（主讲） | 在投影上同步做练习1，让学员跟着看；然后巡场 |
| 梅杭俊（助教） | 从后排开始巡场，优先帮进度慢的学员；确认每人至少完成练习1和2 |

**巡场检查要点：**
- [ ] 学员是否成功用 Claude Code 生成了代码？
- [ ] 学员的 attendance.csv 文件是否存在且内容正确？（常见问题：文件不在当前目录）
- [ ] 学员是否能运行程序看到筛选结果？
- [ ] 学员是否完成了修改筛选条件？
- [ ] 学员能否指出代码中"读取""处理""写入"三个部分？

---

## 常见问题与应对（FAQ）

| 学员问题 | 讲师回应 |
|:---|:---|
| "FileNotFoundError: 找不到文件" | "这是最常见的问题。程序找不到你的文件。先看你在哪个目录：`pwd`。再看文件在不在：`ls`。确保你的终端在 attendance.csv 所在的文件夹。" |
| "`open` 里的 'r' 和 'w' 分别是什么？" | "'r' 是 read（读），'w' 是 write（写）。读文件用 r，写新文件用 w。就像你打开文件有'只读'和'编辑'两种模式。" |
| "CSV 和 Excel 有什么区别？" | "CSV 是纯文本格式，用逗号隔开每一列，任何程序都能读。Excel 是微软的格式，功能更多但也更复杂。CSV 更适合程序处理。Excel 文件也能'另存为 CSV'。" |
| "为什么 `row[0]` 是第一列而不是 `row[1]`？" | "编程世界里数数从0开始，不是从1开始。第一列是 `row[0]`，第二列是 `row[1]`，以此类推。这是约定，记住就行。" |
| "能处理 Excel 文件吗？" | "可以，但需要额外的工具包。本节课先学 CSV。后面实践课需要的时候，可以让 Claude Code 帮你写处理 Excel 的代码。" |
| "encoding='utf-8' 是什么？" | "这是告诉程序用什么编码方式读文件。中文文件一般用 utf-8。你不需要记住这个，Claude Code 生成代码的时候会自动加上。" |
| "数据量很大会不会很慢？" | "几千行、几万行数据都很快，几秒钟就处理完。只有到几百万行以上才可能有性能问题，工作中很少遇到。" |

---

## 时间应急方案

| 情况 | 方案 |
|:---|:---|
| 文本文件环节超时，CSV 时间不够 | 压缩文本文件的逐行阅读（只重点讲 open/read/write 三个关键行），把时间留给 CSV |
| CSV 环节超时，练习时间不到10分钟 | 砍掉练习3（选做），确保练习1和2完成 |
| 学员理解快，练习提前完成 | 加餐：让学员自己用中文描述一个新的 CSV 处理需求（比如"筛选2月18号的记录"），用 Claude Code 实现 |
| 文件路径问题大量出现 | 暂停，统一讲5分钟文件路径：用 `pwd` 查看当前位置，用 `ls` 确认文件存在，统一 `cd ~/lesson07` |
| Claude Code 不可用 | 使用课前检查材料中的备用代码和预制数据文件 |

---

## 课后讲师反思（每次课后花3分钟填写）

| 维度 | 记录 |
|:---|:---|
| 学员理解"读取→处理→写入"模式的情况 | _____ |
| 学员修改筛选条件的完成率 | _____ / _____ 人 |
| 文件路径问题出现了几次？ | _____ |
| 哪个知识点学员最困惑？ | _____ |
| Claude Code 生成的代码质量如何？ | _____ |
| 时间分配合理吗？哪里超时/不够？ | _____ |
| 下次要调整的地方 | _____ |

---

## 板书/投影要点备忘

课上可以在白板或投影上保留以下内容供学员随时参考：

```
今日核心模式（所有文件处理都是这个套路）：

  读取  →  处理  →  写入
  open('r')   筛选/统计   open('w')
  read()      if/for      write()

读文件：open("文件名", "r")  ← r = read 读
写文件：open("文件名", "w")  ← w = write 写

常见排错：
  找不到文件？ → pwd 看位置，ls 看文件在不在
```
